# CCO Azure Governance Dashboard Governance Version 1.0
<div style="text-align: justify">

- [CCO Azure Governance Dashboard Governance Version 1.0](#cco-azure-governance-dashboard-governance-version-10)
  - [Overview](#overview)
    - [Requirements](#requirements)
  - [APIs in use](#apis-in-use)
  - [Resource Providers requirements](#resource-providers-requirements)
- [Setting up the CCO Azure Governance Dashboard Governance](#setting-up-the-cco-azure-governance-dashboard-governance)
  - [Credentials](#credentials)
    - [Clean Credentials on the Data Source](#clean-credentials-on-the-data-source)
    - [Refresh the dashboard](#refresh-the-dashboard)
    - [Credentials for <span>management.azure.com</span> REST API request:](#credentials-for-managementazurecom-rest-api-request)
    - [Enter Access Web content credentials](#enter-access-web-content-credentials)
    - [Modify Privacy settings](#modify-privacy-settings)
- [Report Pages](#report-pages)
  - [CCO Dashboard overview page](#cco-dashboard-overview-page)
  - [Resource Tags overview page](#resource-tags-overview-page)
  - [Azure Advisor Recommendations Dashboard page](#azure-advisor-recommendations-dashboard-page)
  - [Azure Security Center Recommendations Dashboard page](#azure-security-center-recommendations-dashboard-page)
  - [Azure Security Center Alerts Dashboard tab](#azure-security-center-alerts-dashboard-tab)
  - [Azure VNETs and Subnets Recommendations Dashboard tab](#azure-vnets-and-subnets-recommendations-dashboard-tab)
  - [Azure Compute Dashboard tab](#azure-compute-dashboard-tab)
  - [Role Based Access Control Dashboard tab](#role-based-access-control-dashboard-tab)
  - [Service Principal Role Based Access Control Dashboard tab](#service-principal-role-based-access-control-dashboard-tab)
  - [IaaS Usage and Limits Dashboard tab](#iaas-usage-and-limits-dashboard-tab)
  - [IaaS Idle Resources Dashboard tab](#iaas-idle-resources-dashboard-tab)
  - [Azure Kubernetes Service Dashboard Overview tab](#azure-kubernetes-service-dashboard-overview-tab)
  - [Azure Kubernetes Service Dashboard  tab](#azure-kubernetes-service-dashboard-tab)
- [Scripts](#scripts)
  - [Generate All Subscriptions Advisor Recommendations](#generate-all-subscriptions-advisor-recommendations)
  - [PowerBI Dashboard Read Permissions Role](#powerbi-dashboard-read-permissions-role)
  - [Check last Azure API version](#check-last-azure-api-version)
  - [PowerBI Dashboard Read Permissions Role (JSON)](#powerbi-dashboard-read-permissions-role-json)

## Overview
The CCO Azure Governance Dashboard Governance is a report that aims to aggregate and consolidate the information generated by several Azure services to gain quick insights on your subscriptions to enable data driven business and technical optimization decisions. The main data source for the Dashboard is the **Azure Management REST API**.


### Requirements

- The CCO Azure Governance Dashboard Governance is a Power BI Template that requires to download and install the Microsoft Power BI Desktop Edition from the Microsoft Store. Below you can find the minimum requirements to run the Dashboard
    -    Windows 10 version **14393.0** or **higher**.
    -    Internet access from the computer running Microsoft Power BI desktop.
    - An Azure account on the desired tenant space with permissions on the subscriptions to read from the Azure Services described above.

## APIs in use
<div style="text-align: justify">
The CCO Azure Governance Dashboard Governance pulls the information from several APIs. You can read the public documentation if you need further information about the calls and methods available:
<br><br>
</div>

| API Name| Dashboard API Version | Last API version | Using latest version|
| --- | :---: | :---: |:---: |
| [Azure Advisor](https://docs.microsoft.com/en-us/rest/api/advisor/) | 2017-04-19|2017-04-19|:heavy_check_mark:|
| [Azure Security Center Alerts](https://msdn.microsoft.com/en/US/library/mt704034(Azure.100).aspx)  |2019-01-01 |2019-01-01|:heavy_check_mark:|
| [Azure Security Center Tasks](https://msdn.microsoft.com/en/US/library/mt704034(Azure.100).aspx)  |2015-06-01-preview |2015-06-01-preview|:heavy_check_mark:|
| [Azure Kubernetes Service](https://docs.microsoft.com/en-us/rest/api/aks) | 2019-08-01|2019-08-01|:heavy_check_mark:|
| [Azure Compute](https://docs.microsoft.com/en-us/rest/api/compute) | 2019-03-01|2019-03-01|:heavy_check_mark:|


<div style="text-align: justify">


## Resource Providers requirements

Although some of the Resource Providers might be enabled by default, you need to make sure that at least the **Microsoft.Security** resource provider is registered across all the  subscriptions that you plan analyze using the Dashboard. 

Registering this Resource Provider has no cost or performance penalty on the subscription:

1. Click on **Subscriptions**.
2. Click on the Subscription name you want to configure.
3. Click on **Resource Providers**.
4. Click on **Microsoft.Security** and **Register**.


# Setting up the CCO Azure Governance Dashboard Governance
## Credentials
By default, the template doesn't have any Azure Account credentials preloaded. Hence, the first step to start showing subscriptions data is to sign-in with the right user credentials.

### Clean Credentials on the Data Source
In some cases, old credentials are cached by previous logins using Power BI Desktop and the dashboard might show errors or blank fields.

- Click on Data sources in **Current file/Global permissions**.
- Click on **Clear Permissions**.
- Click on **Clear All Permissions**.

![credentials1](/install/images/Credentials1.png) ![credentials2](/install/images/Credentials2.png)

### Refresh the dashboard
If the permissions and credentials are properly flushed it should ask you for credentials for each REST API and you will have to set the Privacy Levels for each of them.

- Click on **Refresh**.
  
![credentials3](/install/images/Credentials3.png)

### Credentials for <span>management.azure.com</span> REST API request:
- Click on **Organizational Account**.
- Click on **Sign in**.
- Click on **Connect**.


![credentials4](/install/images/Credentials4.png)


### Enter Access Web content credentials

- Make sure that you select **Organization account** type.
- Click on **Sign in**.
  
![credentials7](/install/images/Credentials7.png)

### Modify Privacy settings

 - Go to File -> Options -> Privacy and set to Always ignore privacy level settings.

![Privacy](https://user-images.githubusercontent.com/39730064/60920947-3e6d2580-a24e-11e9-9042-f799c9f6fc53.png)

# Report Pages
## CCO Dashboard overview page
In this page, you will be able to identify the top 5 of recommendations that Azure Advisor and Azure Security Center has identified. You can also locate all the deployed resources in a map.
It's important to mention that this tab just gives you a quick view. All the recommendations will be available with more details in the following tabs

![overview](/install/images/OverviewImage.png)

## Resource Tags overview page
In this page you will be able to sort and filter all your Resources and Resource groups based on Tags. It will help you identify any missing Tag and if your naming standards and Tags classifications adheres to your organization guidelines or policies.

![Tagsoverview](/install/images/TagsOverview.png)

## Azure Advisor Recommendations Dashboard page
In this page of the report, you will be able to identify the total amount of recommendations that Azure Advisor has identified, to what resources each recommendations apply and to what subscription as well.

You can filter the information by:
- Subscription
- Resource Group
- Resource type
- Recommendation type
- Tags

It will also give a high-level overview of what subscriptions require more attention and has more recommendations to snooze or implement.

If you navigate to a impacted resource you will see a quick description, potential solution and in some cases a link to a website where you can find all the steps to solve the problem.

![advisor](/install/images/Advisor.png)

## Azure Security Center Recommendations Dashboard page
In this page, you will be able to identify the total amount of recommendations that Azure Security Center has detected, to what resources apply each recommendation and to what subscription is impacting.

You can filter the information by:
- Subscription
- Resource Group
- Task State
- Resource Type
- Tags
  
It will also give a high-level overview of what subscriptions require more attention and has more recommendations to snooze or implement.

![SecurityCenterRecommendations](/install/images/SecurityCenterRecommendations.png)

## Azure Security Center Alerts Dashboard tab
The fourth tab is used to show the Azure Security Center Advanced Threat Analytics Alerts from all the subscriptions a given Azure account has access to. Is important to remark that subscriptions will need to use the Standard plan if you want to detect and see the alerts in the Power BI Dashboard.

You can filter the information by:
- Data range
- Subscription
- Attack type
- Tags
    
![security Center alerts](/install/images/SecurityCenterAlerts.png)

## Azure VNETs and Subnets Recommendations Dashboard tab
In this tab, you will be able to identify VNETs with only one subnet, if there are any VNET peering and if some of the subnets is exhausting its IP Pool. 

You can filter the information by:
- Subscription
- Resource Group
- VNET
- Subnet
- Networking Interface
  
![azure networking](/install/images/AzureNetworking.png)

**IMPORTANT**: It is important to mention that although a VNET with only one subnet might not be an issue, it might be a good lead to investigate if that is the best network segmentation for the applications running on it.

## Azure Compute Dashboard tab
In this tab, you will be able to identify the number of VMs, the Operating System, the SKU, the Availability Set name, the location, the VM Size, the VNET and subnet each VM is connected, the private IP address and if the VM has any extension installed.

You can filter the information by:
- Subscription
- Resource Group
- If the VM contains containers or no
- Vm extension

![azurecompute](/install/images/AzureCompute.png)

## Role Based Access Control Dashboard tab
This tab is used to show the Azure RBAC permissions from all the subscriptions a given Azure account has access to. You will be able to identify the roles applied to all Azure resources and if the subscriptions have custom roles.

You can filter the information by:
- Subscription
- Resource type

![azure rbac](/install/images/RBAC.png)

## Service Principal Role Based Access Control Dashboard tab
This tab is used to show Azure Services Principals  RBAC permissions from all the subscriptions a given Azure account has access to. You will be able to identify the roles applied to all Azure resources and if the subscriptions have custom roles.

You can filter the information by:
- Subscription
- Resource type

![azure rbacSP](/install/images/RBACServicePrincipals.png)

## IaaS Usage and Limits Dashboard tab
This tab allows to identify the usage of any Compute, Storage and Networking Azure resource and validate the limits for each region and subscription 

You can filter the information by:
- Subscription
- Azure Region

![azure Idle](/install/images/UsageAndLimits.png)

## IaaS Idle Resources Dashboard tab
This tab is lists all the Public IPs, Network Interfaces and Disks that are disconnected, idle or unattached.

You can filter the information by:
- Subscription


![azure Idle](/install/images/IdleResources.png)

## Azure Kubernetes Service Dashboard Overview tab
In this page, you will be able to identify the number of AKS Clusters, Nodes, Pods, Containers, Service Principals and Azure Security Center recommedations. It's important to mention that this tab just gives you a quick view. All the detailed information will be available in the following tab.

You can filter the information by:
- Subscription
- AKS Cluster


![aks](/install/images/aks.PNG)

**IMPORTANT**: to receive all the information related to the Pods, Containers and Container Images a log analytics workspace configured **is required**.
</div>

## Azure Kubernetes Service Dashboard  tab
In this page, you will be able to identify the number of AKS Clusters, Nodes, Pods, Containers, Container images, Service principals and Azure Container Instances . All the information related to these resources will be shown (IPs, pods in use, status, network, image repositories, RBAC roles …).

You can filter the information by:
- Subscription
- AKS Cluster
- Namespace
- Cluster Node

**IMPORTANT**: to receive all the information related to the Pods, Containers and Container Images a log analytics workspace configured **is required**.
</div>

![aks](/install/images/aks2.png)

# Scripts

## Generate All Subscriptions Advisor Recommendations
```
Login-AzureRmAccount

if (-not (Get-Module AzureRm.Profile))
{
Import-Module AzureRm.Profile
}

$azureRmProfileModuleVersion = (Get-Module AzureRm.Profile).Version
# refactoring performed in AzureRm.Profile v3.0 or later
if ($azureRmProfileModuleVersion.Major -ge 3)
{
$azureRmProfile = [Microsoft.Azure.Commands.Common.Authentication.Abstractions.AzureRmProfileProvider]::Instance.Profile
if (-not $azureRmProfile.Accounts.Count)
{
Write-Error "Please run Login-AzureRmAccount before calling this function."
       Break
}
}
else
{
# AzureRm.Profile < v3.0
$azureRmProfile = [Microsoft.WindowsAzure.Commands.Common.AzureRmProfileProvider]::Instance.Profile
If (-not $azureRmProfile.Context.Account.Count)
{
Write-Error "Please run Login-AzureRmAccount before calling this function."
       break
}
}
$Timeout = 60
$currentAzureContext = Get-AzureRmContext
$profileClient = New-Object Microsoft.Azure.Commands.ResourceManager.Common.RMProfileClient($azureRmProfile)
Write-Debug ("Getting access token for tenant" + $currentAzureContext.Subscription.TenantId)
$token = $profileClient.AcquireAccessToken($currentAzureContext.Subscription.TenantId)
$headers = @{"Authorization"="Bearer " + $token.AccessToken}
Write-Debug $token.AccessToken
$SubsList = Get-AzureRmSubscription | where {$_.state -eq "Enabled"}
foreach ($sub in $SubsList)
{
$uri = ("https://management.azure.com/subscriptions/$sub/providers/Microsoft.Advisor/generateRecommendations?api-version=2017-03-31")
Write-Debug ("POST {0}" -f $uri)
$response = Invoke-WebRequest -Uri $uri -Method Post -Headers $headers
$statusUri = $response.Headers.Location
Write-Debug ("GET {0}" -f $statusUri)

$secondsElapsed = 0
while ($secondsElapsed -lt $Timeout)
{
$response = Invoke-WebRequest -Uri $statusUri -Method Get -Headers $headers
if ($response.StatusCode -eq 204) {break}
Write-Verbose ("Waiting for generation to complete for subscription {0}..." -f $sub)
Start-Sleep -Seconds 1
$secondsElapsed++
}
$result = New-Object PSObject -Property @{"SubscriptionId" = $sub; "Status" = "Success"; "SecondsElapsed" = $secondsElapsed}
if ($secondsElapsed -ge $Timeout)
{
$result.Status = "Timed out"
}
Write-Output $result
}
```

## PowerBI Dashboard Read Permissions Role
```
Login-AzureRmAccount

$RoleName = "CCO Azure Governance Dashboard Governance Reader"
Get-AzureRmRoleDefinition $RoleName | Remove-AzureRmRoleDefinition


$SubsList = Get-AzureRmSubscription

$role = Get-AzureRmRoleDefinition "Contributor"
$role.Id = $null
$role.Name = $RoleName
$role.Description = $RoleName
$role.Actions.Clear()

#Global reader permissions
$role.Actions.Add("*/read")

$role.AssignableScopes.Clear()

foreach($Sub in $SubsList)
{
$temp = $Sub.SubscriptionID
$role.AssignableScopes.Add("/subscriptions/$temp")
}

New-AzureRmRoleDefinition -Role $role
```
## Check last Azure API version
```
Login-AzureRmAccount
Get-AzureRmSubscription | Out-GridView -PassThru

#Resource Types
$ref = @('^recommendations$', '^tasks$', '^alerts$','^managedClusters$','^virtualMachines$','^virtualNetworks$','^networkInterfaces$','^networkInterfaces$','^resourceGroups$','^subscriptions$','^resources$','^roleAssignments$','^roleDefinitions$','^networkSecurityGroups$')    
$refRegex = [string]::Join('|', $ref) 
#Resource Providers
$ref2 = @('Microsoft.Resources','Microsoft.Network','Microsoft.Advisor','Microsoft.Compute','Microsoft.ContainerService','Microsoft.Security','Microsoft.Authorization')
$ref2Regex = [string]::Join('|', $ref2)

#Resource Types (location only for resources)
$ref3 = @('^resourceGroups$','^subscriptions$','^locations$')    
$ref3Regex = [string]::Join('|', $ref3) 

$providers = Get-AzureRmResourceProvider 
$providers | %{
    if ($_.ProviderNamespace -match $ref2Regex){
        "******************************************************************"
        "### Provider:          "+$_.ProviderNamespace
        $resourcetypes = (Get-AzureRmResourceProvider -ProviderNamespace $_.ProviderNamespace).ResourceTypes
        #"### Resource Types:    " + ((Get-AzureRmResourceProvider -ProviderNamespace $_.ProviderNamespace).ResourceTypes).count
        ""
        #We only want to show location resource API version if the provider is Microsoft.Resources
        if ($_.ProviderNamespace -eq 'Microsoft.Resources'){ 
                $resourcetypes | %{
                    If ($_.ResourceTypeName -match $ref3Regex){
                        "- Resource Type Name:  " + $_.ResourceTypeName 
                        "- API last version:    " + ($_.ApiVersions | Select-Object -First 1)
                        ""
                    }
                }
        }
        else{
            $resourcetypes | %{
                    If ($_.ResourceTypeName -match $refRegex){
                        "- Resource Type Name:  " + $_.ResourceTypeName 
                        "- API last version:    " + ($_.ApiVersions | Select-Object -First 1)
                        ""
                    }
            }
        }
    }
}
```
## PowerBI Dashboard Read Permissions Role (JSON)

```
{
    "name": "string",
    "type": "Microsoft.Authorization/roleDefinitions",
    "apiVersion": "2017-09-01",
    "properties": {
      "Name":  "Continous Optimization Dashboard Reader",
      "Id":  null,
      "IsCustom":  true,
      "Description":  "Can read Resources, Azure Security Center and Advisor Information",
      "Actions":  [
                      "Microsoft.Advisor/generateRecommendations/action", 
                      "*/Read"
                  ],
      "NotActions":  [],
          
      "AssignableScopes":  [                          
                               "/subscriptions/XXXXXXXXXXXXXXXXXXXXX"                             
                           ]
      }
  }
```
